# Nginx Configuration for Ramniya Creations
# Save as: /etc/nginx/sites-available/ramniya-creations

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # Redirect HTTP to HTTPS (production)
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL Configuration (use Let's Encrypt certbot)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Logs
    access_log /var/log/nginx/ramniya-access.log;
    error_log /var/log/nginx/ramniya-error.log;

    # Max upload size (must match backend limit)
    client_max_body_size 10M;

    # Serve static uploads
    location /uploads/ {
        alias /var/www/ramniya/uploads/;

        # Cache images for 1 year
        expires 1y;
        add_header Cache-Control "public, immutable";

        # Security: Prevent execution of scripts
        location ~ \.(php|cgi|pl|py|sh|jsp|asp|aspx)$ {
            deny all;
        }

        # Enable CORS for images (if needed)
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";

        # Serve placeholder for missing images
        try_files $uri /uploads/placeholder.jpg =404;

        # Enable compression for image types
        gzip on;
        gzip_vary on;
        gzip_types image/jpeg image/png image/webp;
    }

    # Proxy to Go backend
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Serve frontend (if serving from Nginx)
    location / {
        root /var/www/ramniya/frontend;
        try_files $uri $uri/ /index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}

# Development/Local Configuration
# Save as: /etc/nginx/sites-available/ramniya-creations-dev
server {
    listen 80;
    server_name localhost;

    # Logs
    access_log /var/log/nginx/ramniya-dev-access.log;
    error_log /var/log/nginx/ramniya-dev-error.log;

    # Max upload size
    client_max_body_size 10M;

    # Serve static uploads
    location /uploads/ {
        alias /var/www/ramniya/uploads/;

        # No cache in development
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";

        # Security: Prevent execution
        location ~ \.(php|cgi|pl|py|sh|jsp|asp|aspx)$ {
            deny all;
        }

        # Placeholder for missing images
        try_files $uri /uploads/placeholder.jpg =404;
    }

    # Proxy to Go backend
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend (Vite dev server)
    location / {
        proxy_pass http://localhost:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

# Installation Instructions:
#
# 1. Copy configuration:
#    sudo cp ramniya-nginx.conf /etc/nginx/sites-available/ramniya-creations
#
# 2. Create upload directory:
#    sudo mkdir -p /var/www/ramniya/uploads
#    sudo chown -R www-data:www-data /var/www/ramniya/uploads
#    sudo chmod -R 755 /var/www/ramniya/uploads
#
# 3. Create placeholder image:
#    sudo mkdir -p /var/www/ramniya/uploads
#    # Create or copy placeholder.jpg to /var/www/ramniya/uploads/
#
# 4. Enable site:
#    sudo ln -s /etc/nginx/sites-available/ramniya-creations /etc/nginx/sites-enabled/
#
# 5. Test configuration:
#    sudo nginx -t
#
# 6. Reload Nginx:
#    sudo systemctl reload nginx
#
# 7. For HTTPS (production), install certbot:
#    sudo apt install certbot python3-certbot-nginx
#    sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com